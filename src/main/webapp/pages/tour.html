<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="u" uri="util" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

<fmt:setLocale value="${locale}" scope="session" />
<fmt:setBundle basename="lang" var="rb" />

<html>
<head>
    <title>Tour Agency</title>
    <c:import url="/resources/components/head.html"/>
    <link rel="stylesheet" href="/resources/css/review.css"/>
    <link rel="stylesheet" href="/resources/css/purchase.css"/>
    <link rel="stylesheet" href="/resources/bower_components/rateYo/src/jquery.rateyo.css"/>
    <script src="/resources/js/util.js"></script>
</head>
<body>

<c:import url="/resources/components/navbar.html"/>

<input type="hidden" id="rating-val" value="${tour.avgRating}"/>

<div class="container-fluid">
    <div class="col-md-3 sidebar">
        <c:import url="/resources/components/sidebar.html"/>
    </div>

    <div class="col-md-offset-3 col-md-8 content">
        <div class="row">
            <div class="col-offset-md-1 col-md-12">
                <div class="pull-left">
                    <h3>
                        <c:out value="${tour.title}"/>
                    </h3>
                    <div class="price">
                        $${tour.price.doubleValue()}
                    </div>
                </div>
                <div class="pull-right">
                    <div class="vcentered-container">
                        <div id="rating" class="vcentered" style="display: inline-block"></div>
                            (<a class="vcentered" href="">${tour.votesCount}</a>)
                    </div>
                </div>
            </div>
        </div>

        <br/>

        <div class="row">
            <div class="col-offset-md-1 col-md-12">
                <c:if test="${discount > 0}">
                    <div class="pull-right discount">
                        -${discount}%
                    </div>
                </c:if>
                <div class="tour-desc col-md-10">
                    <c:out value="${tour.description}"/>
                </div>
            </div>
        </div>

        <br/>

        <fmt:message key="buy.buy" var="buy" bundle="${rb}"/>

        <div class="row">
            <div class="col-offset-md-1 col-md-12">
                <a class="btn pull-right"
                   href="/user/buy.html?tourId=${tour.id}">${buy}</a>
            </div>
        </div>

        <hr/>

        <div class="row">
            <div class="col-offset-md-1 col-md-12">
                <h3>
                    Відгуки
                </h3>

                <c:if test="${canVote}">
                    <center>
                        <div id="new-review-btn"><i class="glyphicon glyphicon-plus-sign"></i></div>
                    </center>
                </c:if>

                <br/>

                <div id="new-review" class="hidden">
                    <div class="review clearfix">
                        <div class="review-header">
                            <div class="vcentered-container">
                                <div class="new-review-stars vcentered" style="display: inline-block">
                                </div>
                                <div class="counter inline vcentered"></div>
                            </div>
                        </div>

                        <form id="new-review-form" method="post" action="/review">
                            <div class="form-group">
                                <input type="hidden" id="new-review-rating"
                                       name="rating" value=""/>
                                <input type="hidden" name="tourId" value="${tour.id}"/>
                                <input type="hidden" name="userId" value="${user.id}"/>
                                <textarea class="form-control" id="text" name="text"></textarea>
                            </div>

                            <input type="submit" class="btn pull-right btn-contrast"
                                   id="submit-review" disabled="disabled"
                                   value="Оцінити" >
                            </input>
                        </form>
                    </div>
                </div>

                <div class="reviews">
                    <c:forEach var="review" items="${reviews}">
                        <div class="review">
                            <div class="review-header clearfix">
                                <div class="pull-left">
                                    <div class="vcentered-container inline">
                                        <span class="rating-box vcentered">${review.rating}</span>
                                        <span class="push-right-sm">Good</span>
                                    </div>
                                </div>
                                <div class="review-author pull-right clearfix">
                                    ${review.author.firstName} ${review.author.lastName}
                                    <c:if test="${user.id == review.author.id || agent}">
                                        <form method="post" action="/review"
                                              class="clear-margin inline">
                                            <input type="hidden" name="__method" value="DELETE"/>
                                            <input type="hidden" name="id" value="${review.id}"/>
                                            <div class="submit danger">
                                                <i class="glyphicon glyphicon-remove"></i>
                                            </div>
                                        </form>
                                    </c:if>
                                </div>
                            </div>
                            <c:if test="${not empty review.text}">
                                <div class="review-content">
                                    <c:out value="${review.text}"/>
                                </div>
                            </c:if>
                        </div>
                    </c:forEach>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="/resources/bower_components/rateYo/src/jquery.rateyo.js"></script>

<script>
$(function () {
  var mess = {
    0: "",
    1: "Very bad",
    2: "Bad",
    3: "Moderate",
    4: "Good",
    5: "Exciting!"
  };

  processSubmitDivs($);

  var $submitReview = $("#submit-review");
  var $newReviewRating = $("#new-review-rating");

  $("#rating").rateYo({
    rating: $("#rating-val").val(),
    readOnly: true
  });
  $(".new-review-stars").rateYo({
    fullStars: true,
    precision: 0,

    onSet: function(rating) {
        $submitReview.removeAttr('disabled');
        $newReviewRating.val(rating);
    },

    onChange: function(rating, self) {
        $(this).next().text(mess[rating]);
    }
  });
  $("#new-review-btn").click(function() {
    $("#new-review").removeClass("hidden");
    $(this).hide();
  });
});
</script>

</body>
</html>