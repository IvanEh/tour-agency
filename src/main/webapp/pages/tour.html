<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="u" uri="util" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

<fmt:setLocale value="${locale}" scope="session" />
<fmt:setBundle basename="lang" var="rb" />

<html>
<head>
    <title>Tour Agency</title>
    <c:import url="/resources/components/head.html"/>
    <link rel="stylesheet" href="/resources/css/review.css"/>
    <link rel="stylesheet" href="/resources/css/purchase.css"/>
    <link rel="stylesheet" href="/resources/css/galery.css"/>
    <link rel="stylesheet" href="/resources/css/dropdown.css"/>
    <link rel="stylesheet" href="/resources/bower_components/lightbox2/dist/css/lightbox.css"/>
    <link rel="stylesheet" href="/resources/bower_components/rateYo/src/jquery.rateyo.css"/>
    <link rel="stylesheet" href="/resources/bower_components/jquery.filer/css/jquery.filer.css"/>
    <script src="/resources/js/util.js"></script>
    <script src="/resources/bower_components/lightbox2/dist/js/lightbox.js"></script>
    <script src="/resources/bower_components/bootstrap/js/modal.js"/></script>
    <script src="/resources/bower_components/jquery.filer/js/jquery.filer.js"></script>
</head>
<body>

<c:import url="/resources/components/navbar.html"/>

<input type="hidden" id="rating-val" value="${tour.avgRating}"/>

<div class="container-fluid">
    <div class="col-md-3 sidebar">
        <c:import url="/resources/components/sidebar.html"/>
    </div>

    <div class="col-md-offset-3 col-md-8 content">
        <div class="row">
            <div class="col-offset-md-1 col-md-12">
                <div class="pull-left">
                    <h3>
                        <c:out value="${tour.title}"/>
                    </h3>
                    <div class="price">
                        $${tour.price.doubleValue()}
                    </div>
                </div>
                <div class="pull-right">
                    <div class="vcentered-container">
                        <div id="rating-static" class="vcentered" style="display: inline-block"></div>
                            (<a class="vcentered" href="">${tour.votesCount}</a>)
                    </div>
                </div>
            </div>
        </div>

        <br/>

        <div class="row">
            <div class="col-offset-md-1 col-md-12">
                <c:if test="${discount > 0}">
                    <div class="pull-right discount">
                        -${discount}%
                    </div>
                </c:if>
                <div class="tour-desc col-md-10">
                    <c:out value="${tour.description}"/>
                </div>
            </div>
        </div>

        <br/>

        <fmt:message key="buy.buy" var="buy" bundle="${rb}"/>

        <div class="row">
            <div class="col-offset-md-1 col-md-12">
                <a class="btn pull-right"
                   href="/user/buy.html?tourId=${tour.id}">${buy}</a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 galery">
                <c:forEach var="tourImage" items="${tourImages}">
                    <div class="image-container pull-left">
                        <div class="image dropdown">
                            <a href="${tourImage.imageUrl}" class="image"
                               data-lightbox="image-1">
                                <div class="image-frame">
                                    <img src="${tourImage.thumbnailUrl}"/>
                                </div>
                            </a>

                            <u:if-user role="TOUR_AGENT">
                                <div class="dropdown-content">
                                    <a href="#" data-action="removeImage"
                                       data-id="${tourImage.id}"><i class="glyphicon glyphicon-trash"></i></a>
                                    <!--<a href="#"><i class="glyphicon glyphicon-trash"></i></a>-->
                                </div>
                            </u:if-user>
                        </div>
                    </div>
                </c:forEach>

                <div class="vcentered-container image-container pull-left hidden"
                     id="image-template">
                    <div class="vcentered">
                        <center>
                            <div class="btn-circ-new">
                                <i class="glyphicon glyphicon-open"></i>
                            </div>
                        </center>
                    </div>
                </div>

                <u:if-user role="TOUR_AGENT">
                    <div class="vcentered-container image-container pull-left"
                         id="upload-images-action">
                        <div class="vcentered">
                            <center>
                                <div class="btn-circ-new" data-toggle="modal"
                                     data-target="#upload-images-modal">
                                    <i class="glyphicon glyphicon-plus-sign"></i>
                                </div>
                            </center>
                        </div>
                    </div>
                </u:if-user>
            </div>
        </div>

        <hr/>

        <div class="row">
            <div class="col-offset-md-1 col-md-12">
                <h3>
                    Відгуки
                </h3>

                <c:if test="${canVote}">
                    <center>
                        <div id="new-review-btn"><i class="glyphicon glyphicon-plus-sign"></i></div>
                    </center>
                </c:if>

                <br/>

                <div id="new-review" class="hidden">
                    <div class="review clearfix">
                        <div class="review-header">
                            <div class="vcentered-container">
                                <div class="new-review-stars vcentered" style="display: inline-block">
                                </div>
                                <div class="counter inline vcentered"></div>
                            </div>
                        </div>

                        <form id="new-review-form" method="post" action="/review">
                            <div class="form-group">
                                <input type="hidden" id="new-review-rating"
                                       name="rating" value=""/>
                                <input type="hidden" name="tourId" value="${tour.id}"/>
                                <input type="hidden" name="userId" value="${user.id}"/>
                                <textarea class="form-control" id="text" name="text"></textarea>
                            </div>

                            <input type="submit" class="btn pull-right btn-contrast"
                                   id="submit-review" disabled="disabled"
                                   value="Оцінити" >
                            </input>
                        </form>
                    </div>
                </div>

                <div class="reviews">
                    <c:forEach var="review" items="${reviews}">
                        <div class="review">
                            <div class="review-header clearfix">
                                <div class="pull-left">
                                    <div class="vcentered-container inline">
                                        <span class="rating-box vcentered">${review.rating}</span>
                                        <span class="push-right-sm">Good</span>
                                    </div>
                                </div>
                                <div class="review-author pull-right clearfix">
                                    ${review.author.firstName} ${review.author.lastName}
                                    <c:if test="${user.id == review.author.id || agent}">
                                        <form method="post" action="/review"
                                              class="clear-margin inline">
                                            <input type="hidden" name="__method" value="DELETE"/>
                                            <input type="hidden" name="id" value="${review.id}"/>
                                            <div class="submit danger">
                                                <i class="glyphicon glyphicon-remove"></i>
                                            </div>
                                        </form>
                                    </c:if>
                                </div>
                            </div>
                            <c:if test="${not empty review.text}">
                                <div class="review-content">
                                    <c:out value="${review.text}"/>
                                </div>
                            </c:if>
                        </div>
                    </c:forEach>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="upload-images-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Load image</h4>
            </div>
            <div class="modal-body">
                <form action="/image-provider" id="images-upload" method="post" enctype="multipart/form-data">
                  <input type="file" name="images" id="images-input" multiple="multiple">
                  <input type="submit" class="hidden">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="upload-images-btn">Upload</button>
            </div>
        </div>
    </div>
</div>

<form action="/tour-images" method="post"
      id="tour-images-create-form">
    <input type="hidden" name="tourId" value="${tour.id}"/>
    <input type="hidden" name="imageUrl" value=""/>
    <input type="hidden" name="thumbnailUrl" value=""/>
</form>

<form action="/tour-images" method="post"
      id="tour-image-remove-form">
    <input type="hidden" name="__method" value="DELETE"/>
    <input type="hidden" name="id" value=""/>
</form>


<script src="/resources/bower_components/rateYo/src/jquery.rateyo.js"></script>

<script src="/resources/js/tour.html.js"></script>

</body>
</html>